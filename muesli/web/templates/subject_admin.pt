<!--  -*- coding: utf-8 -*-                                                 -->
<!--  muesli/web/templates/subject_admin.pt                               -->
<!--                                                                        -->
<!--  This file is part of MUESLI.                                          -->
<!--  Copyright (C) 2022, Tobias Wackenhut <tobias (at) wackenhut.at>       -->
<!--                                                                        -->
<!--  This program is free software: you can redistribute it and/or modify  -->
<!--  it under the terms of the GNU General Public License as published by  -->
<!--  the Free Software Foundation, either version 3 of the License, or     -->
<!--  (at your option) any later version.                                   -->
<!--                                                                        -->
<!--  This program is distributed in the hope that it will be useful,       -->
<!--  but WITHOUT ANY WARRANTY; without even the implied warranty of        -->
<!--  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         -->
<!--  GNU General Public License for more details.                          -->
<!--                                                                        -->
<!--  You should have received a copy of the GNU General Public License     -->
<!--  along with this program.  If not, see <http://www.gnu.org/licenses/>. -->

<!DOCTYPE HTML>
<metal:main metal:use-macro="templates('Fragments/main.pt').macros['main']">
  <metal:main metal:fill-slot="content">
    <script type="text/javascript">/* <![CDATA[ */
    $(document).ready(function () {
      $('#migration_subject_select').select2({
        dropdownParent: $('#subject_deletion'),
        width: "25em"
      });

      $('#subject_deletion').on('show.bs.modal', function (event) {
        let subject_id = event.relatedTarget.dataset.subject;
        let row = document.querySelector(`tr[data-subject="$${subject_id}"]`);
        document.querySelector('#deletion_modal_subject_field').textContent = row.querySelector('.subject-name').value;
        document.querySelector('#deletion_modal_button').dataset.subject = subject_id;
      });

      $('#deletion_modal_button').on('click', function (event) {
        let subject_id = event.target.dataset.subject;
        let migration_target = parseInt(document.querySelector('#migration_subject_select').value);
        $.ajax({
          url: `/api/v1/subjects/$${subject_id}`,
          method: 'DELETE',
          dataType: 'json',
          data: JSON.stringify({
            migrate: migration_target !== -1,
            migration_target_id: migration_target,
          }),
          success: function () {
            $.snack("info", 'Studienfach gelöscht', 10000);
            document.querySelector(`tr[data-subject="$${subject_id}"]`).remove();
            $('#subject_deletion').modal('hide');
          },
          error: function (response) {
            $.toast({
              type: "error",
              title: "Fehler beim Löschen oder Zusammenführen.!",
              content: response["errors"],
              delay: 10000
            });
          }
        })
      });
    });

    function update_subject(subject_id) {
        let row = document.querySelector(`tr[data-subject="$${subject_id}"]`);
        let name = row.querySelector('.subject-name').value;
        let curated = row.querySelector('.subject-curate-checkbox').checked;
        $.ajax({
          url: `/api/v1/subjects/$${subject_id}`,
          method: 'PUT',
          dataType: 'json',
          data: JSON.stringify({
            name: name,
            curated: curated,
          }),
          success: function() {
            $.snack("info", 'Änderungen gespeichert', 10000);
          },
          error: function(response) {
            $.toast({
              type: "error",
              title: "Fehler beim Speichern!",
              content: response["errors"],
              delay: 10000
            });
          }
        })
    }

    function transfer_students() {
      let subject_from = document.querySelector('.subject-from').value;
      let subject_to = document.querySelector('.subject-to').value;

      $.ajax({
        url: "${request.route_path('subject_transfer_students')}",
        method: 'PUT',
        dataType: 'json',
        data: JSON.stringify({
          subject_from: parseInt(subject_from),
          subject_to: parseInt(subject_to)
        }),
        success: function () {
          $.snack("success", 'Änderungen gespeichert', 10000);
        },
        error: function () {
          $.toast({
            type: "error",
            title: "Fehler beim Speichern!",
            content: response["msg"],
            delay: 10000
          });
        }
      })
      return false;
    }

    /* ]]> */
    </script>

    <!--
      Modal for subject deletion.
    -->
    <div class="modal fade" id="subject_deletion" tabindex="-1" role="dialog" aria-labelledby="Studienfach löschen oder zusammenführen"
         aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Studienfach löschen oder zusammenführen</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Schließen">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>Wollen Sie folgendes Studienfach wirklich entfernen?</p>
            <p id="deletion_modal_subject_field">TO BE FILLED BY JS</p>
            <label>
              Studis übertragen in:
              <select id="migration_subject_select">
                <option value="-1">Ohne Ersatz löschen (Keine Migration)</option>
                <option tal:repeat="subject subjects" tal:attributes="value subject.id">${subject.name}</option>
              </select>
            </label>
          </div>
          <div class="modal-footer">
            <a role="button" class="btn btn-danger" id="deletion_modal_button" data-subject="">Löschen</a>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Abbrechen</button>
          </div>
        </div>
      </div>
    </div>

    <h2>Studienfächer verwalten</h2>
    <p>Achtung: Änderungen an den Titeln und dem Korrekturstatus werden direkt übernommen!</p>
    <table>
      <thead>
      <tr>
        <th>Fach</th>
        <th>Korrektheit geprüft</th>
        <th></th>
      </tr>
      </thead>
      <tbody>
      <tr tal:repeat="subject subjects" tal:attributes="data-subject subject.id">
        <td><input type="text" class="subject-name" tal:attributes="value subject.name ; onchange 'update_subject(' + str(subject.id) + ')'"></td>
        <td><input type="checkbox" class="subject-curate-checkbox" tal:attributes="checked 'checked' if subject.curated else None ; onclick 'update_subject(' + str(subject.id) + ')'"></td>
        <td><button type="button" class="btn btn-secondary" tal:attributes="data-subject subject.id"  data-toggle="modal" data-target="#subject_deletion">Löschen oder Zusammenführen</button></td>
      </tr>
      </tbody>
    </table>

  </metal:main>
</metal:main>
